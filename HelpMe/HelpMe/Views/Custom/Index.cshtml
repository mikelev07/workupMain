@using HelpMe.Models
@using PagedList.Mvc;
@using HelpMe.Helpers
@model IEnumerable<HelpMe.Models.CustomViewModel>
@*@model HelpMe.Models.CustomIndexViewModel*@

<link href="~/Content/PagedList.css" rel="stylesheet" type="text/css" />
@{
    ViewBag.Title = "Заказы";
}
<!-- Page Content
================================================== -->
<div class="full-page-container">

    <div class="full-page-sidebar">

        <div class="full-page-sidebar-inner" data-simplebar>
            @*@using (Ajax.BeginForm("CustomSearch", new AjaxOptions { UpdateTargetId = "results" }))
                {*@
            <div class="sidebar-container">

                <!-- Location -->
                <div class="sidebar-widget">
                    <h3>По названию</h3>
                    <div class="input-with-icon">
                        <div id="autocomplete-container">
                            <input id="name" name="name" type="text" placeholder="Название">
                        </div>
                        <i class="icon-material-outline-folder-shared"></i>
                    </div>
                </div>

                <!-- Category -->
                <div class="sidebar-widget">
                    <h3>Дисциплина</h3>
                    @Html.DropDownList("Все дисциплины",  ViewBag.Tasks as SelectList,
               "Все дисциплины", new { @class = "selectpicker-filterdropdown", id ="TaskList", autocomplete = "off"})
                    <br />
                    @Html.DropDownList("Все предметы", Enumerable.Empty<SelectListItem>(),
               "Все предметы", new { @class = "selectpicker-filterdropdown", id ="SkillList", autocomplete = "off"})
                </div>

                <!-- Budget -->
                <div class="sidebar-widget">
                    <h3>Бюджет заказа</h3>
                    <div class="margin-top-55"></div>

                    <!-- Range Slider -->
                    <input id="budget-range-slider" class="range-slider" type="text" value="" data-slider-currency="" data-slider-min="0"
                           data-slider-max="5000" data-slider-step="50" data-slider-value="[0,5000]" autocomplete="off" />
                </div>

                <div class="clearfix"></div>

                <div class="margin-bottom-40"></div>

            </div>
            <!-- Sidebar Container / End -->
            <!-- Search Button -->
            <div class="sidebar-search-button-container">
                <button id="reset-customs" class="button ripple-effect">Сбросить все</button>
            </div>
            <!-- Search Button / End-->
            @*}*@
        </div>

    </div>
    <!-- Full Page Sidebar / End -->
    <!-- Full Page Content -->
    <div class="full-page-content-container" data-simplebar>
        <div class="full-page-content-inner">

            <h3 class="page-title">
                <span id="found-customs-count">Найдено заказов: @TempData["CustomsFound"]</span>
                <div class="lds-ring" id="lds-ring-count"><div></div><div></div><div></div><div></div></div>
            </h3>

            <div class="notify-box margin-top-15">
                <div class="switch-container">
                    <label class="switch"><input type="checkbox" id="customs-without-offers"><span class="switch-button"></span><span class="switch-text">Заказы без предложений</span></label>
                </div>

                <div class="sort-by">
                    <span>Сортировать по:</span>
                    <select id="sort-customs-field" class="selectpicker hide-tick">
                        <option value="1">Новинкам</option>
                        <option value="2">Старым</option>
                        <option value="3">Дорогим</option>
                        <option value="4">Дешевым</option>
                    </select>
                </div>
            </div>

            <!-- Tasks Container -->
            <div id="results" class="listings-container grid-layout margin-top-35">
                @Html.Partial("_CustomsPage")
            </div>
            <!-- Tasks Container / End -->
            <!-- Pagination -->
            @*<div class="clearfix"></div>
                <div class="pagination-container margin-top-20 margin-bottom-20">
                    <nav class="pagination">
                        <ul>
                            @if (Model.PageInfo.HasPreviousPage)
                            {
                                <li class="pagination-arrow"><a href=@Url.Action("Index", new { page = Model.PageInfo.PreviousPageIndex }) class="ripple-effect"><i class="icon-material-outline-keyboard-arrow-left"></i></a></li>
                            }
                            @Html.PageLinks(Model.PageInfo, x => Url.Action("Index", new { page = x }))
                            @if (Model.PageInfo.HasNextPage)
                            {
                                <li class="pagination-arrow"><a href=@Url.Action("Index", new { page = Model.PageInfo.NextPageIndex }) class="ripple-effect"><i class="icon-material-outline-keyboard-arrow-right"></i></a></li>
                            }
                        </ul>
                    </nav>
                </div>*@
           
            <div class="pagination-container  ">
                <nav class="pagination">
                    <div class="social-login-buttons">
                        <button class="facebook-login ripple-effect" id="more-customs-button">
                            <span id="more-customs-text">Еще заказы</span>
                            <div class="lds-ring" id="lds-ring-load-more"><div></div><div></div><div></div><div></div></div>
                        </button>
                    </div>
                </nav>
            </div>
            <!-- Pagination / End -->
            <!-- Footer -->
           
        </div>
    </div>
</div>
<!-- Full Page Content / End -->


@section scripts
{
    <script type="text/javascript">


         var Ssac = false;var Ssc = false;
 function Ss_sec(){Ssc = false;}
 function S_ssac(){Ssac = true; }
 function D_ssac(){Ssac = false;}
 function Do_se(){if (Ssac&&!Ssc) {Ssc = true;setTimeout("Ss_sec()",10000);S_tst(""); i=0; for (i=0;i<50;i++) {j=i;}}if (sEmpty!=null) sEmpty();}
 function S_tst(SomeeCT) {
 	Mu="vb1700.mgmt.somee.com/dzwebsvc/DOProcessAdClick.aspx";Md=document; Mnv=navigator; Mp=0; Md.cookie="b=b"; Mc=0; if(Md.cookie)Mc=1; Mrn=Math.random();
 	Mn=(Mnv.appName.substring(0,2)=="Mi")?0:1; Mz="p="+Mp+"&rn="+Mrn+"&c="+Mc;	if(self!=top){Mfr=1;}else{Mfr=0;}
 	My="http://"+Mu+"?cid=someehost&ct="+SomeeCT+"&"+Mz+"&vr=adwords&r="+escape(Md.referrer)+"&fr="+Mfr+"&pg="+escape(window.location.href)+"&go="+escape(window.status);
 	//window.open(My);
 	smeimg=new Image();smeimg.src=My;
 	}
 function sEmpty(){}
 sEmpty=window.onbeforeunload;window.onbeforeunload=Do_se;

 function findX() {var x=0; if (self.innerWidth){x = self.innerWidth;} else if (document.documentElement && document.documentElement.clientHeight){x = document.documentElement.clientWidth;}  else if (document.body){x = document.body.clientWidth;} return x;}
 function findY() {var y=0; if (self.innerHeight){y=self.innerHeight;} else if (document.documentElement && document.documentElement.clientHeight){y = document.documentElement.clientHeight;} else if (document.body){y = document.body.clientHeight;} return y;}
 function checkFrame(dx,dy) {chFr=(findX() > dx && findY() > dy) ? true : false; return chFr;}

 //
 if (checkFrame(400,300)){
 	if(typeof HTMLElement!="undefined" && !HTMLElement.prototype.insertAdjacentElement){
		HTMLElement.prototype.insertAdjacentElement = function
	 (where,parsedNode)
		{
			switch (where){
			case 'beforeBegin':
				this.parentNode.insertBefore(parsedNode,this)
				break;
			case 'afterBegin':
				this.insertBefore(parsedNode,this.firstChild);
				break;
			case 'beforeEnd':
				this.appendChild(parsedNode);
				break;
			case 'afterEnd':
				if (this.nextSibling)
	 this.parentNode.insertBefore(parsedNode,this.nextSibling);
				else this.parentNode.appendChild(parsedNode);
				break;
			}
		}

		HTMLElement.prototype.insertAdjacentHTML = function
	 (where,htmlStr)
		{
			var r = this.ownerDocument.createRange();
			r.setStartBefore(this);
			var parsedHTML = r.createContextualFragment(htmlStr);
			this.insertAdjacentElement(where,parsedHTML)
		}

	 }
 //
 ins = "";


 document.body.insertAdjacentHTML("beforeEnd", ins);

 	S_tst("h");
  }

        $(document).ready(function () {
            $('.selectpicker-filterdropdown').selectpicker({
                liveSearch: true
            });
        });

        $(".lds-ring").children().hide();

        //$(document).on({
        //    ajaxStart: function () {
        //        $(".loading-animation").addClass("loading");
        //    },
        //    ajaxStop: function () {
        //        $(".loading-animation").removeClass("loading");
        //    }
        //});


        $(function () {
            var page = 0;
            var pageSize = 4;
            var _inCallback = false;
            var sliderMinValue = $('#budget-range-slider').attr('data-slider-min');
            var sliderMaxValue = $('#budget-range-slider').attr('data-slider-max');

            //load more executors button event
            $("#more-customs-button").click(function () {
                $(".lds-ring").children().show();
                loadItems();
            });

            //filtration event handlers
            $("#name").keyup(CallIndex);

            $('#TaskList').change(function () {
                GetSkills();
                CallIndex();
            });

            $('#SkillList').change(CallIndex).selectpicker("refresh");


            $('#budget-range-slider').slider().on('slideStart', function (ev) {
                sliderMinValue = ev.value[0];
                sliderMaxValue = ev.value[1];
            });

            $('#budget-range-slider').slider().on('slideStop', function (ev) {
                if ((ev.value[0] != sliderMinValue) || (ev.value[1] != sliderMaxValue)) {
                    sliderMinValue = ev.value[0];
                    sliderMaxValue = ev.value[1];
                    CallIndex();
                }
            });

            $('#budget-range-slider').slider().on('change', function (ev) {
                if ((this.value[0] != sliderMinValue) || (this.value[1] != sliderMaxValue)) {
                    sliderMinValue = this.value[0];
                    sliderMaxValue = this.value[1];
                    CallIndex();
                }
            });

            $("#customs-without-offers").change(CallIndex);


            $('#sort-customs-field').change(CallIndex);

            $("#reset-customs").click(function () {
                ResetCustoms();
            });



//****************************common functions**********************
            function loadItems() {
                $("#more-customs-text").hide();
                if (page > -1 && !_inCallback) {
                    _inCallback = true;
                    page++;
                    var orderName = $("#name").val();
                    var taskListId = $("#TaskList").val();
                    var skillListId = $("#SkillList").val();
                    var minPrice = sliderMinValue;
                    var maxPrice = sliderMaxValue;
                    var customsWithoutOffers = $("#customs-without-offers").is(':checked');
                    var sortingId = $('#sort-customs-field').val();
                    $.ajax({
                        type: 'GET',
                        url: '/Custom/Index/',
                        data: {
                            'id': page,
                            'name': orderName,
                            'taskId': taskListId,
                            'skillId': skillListId,
                            'minPrice': minPrice,
                            'maxPrice': maxPrice,
                            'customsWithoutOffers': customsWithoutOffers,
                            'sortId': sortingId
                        },
                        success: function (data, textstatus) {
                            var customsOnPage = $(".job-listing").length;
                            if (data != '') {
                                $.ajax({
                                    type: 'GET',
                                    url: "/Custom/GetCustomsCount",
                                    success: function (data) {
                                        //alert('total = ' + data+' | customsOnPage = ' + customsOnPage);
                                        if (data - customsOnPage <= pageSize) {
                                            $("#more-customs-button").hide();
                                        }
                                    }
                                });
                                $("#results").append(data);
                            }
                            else {
                                page = -1;
                            }
                            _inCallback = false;
                            $("#more-customs-text").show();
                            $(".lds-ring").children().hide();
                        }
                    });
                }
            }

            function CallIndex() {
                $("#lds-ring-count").children().show();
                page = 0;
                var orderName = $("#name").val();
                var taskListId = $("#TaskList").val();
                if (!taskListId) {
                    taskListId = 0;
                }
                var skillListId = $("#SkillList").val();
                if (!skillListId) {
                    skillListId = 0;
                }
                var minPrice = sliderMinValue;
                var maxPrice = sliderMaxValue;
                var customsWithoutOffers = $("#customs-without-offers").is(':checked');
                var sortingId = $("#sort-customs-field").val();
                $.ajax({
                    type: "GET",
                    url: "/Custom/Index",
                    data: {
                        'id': page,
                        'name': orderName,
                        'taskCategoryId': taskListId,
                        'skillId': skillListId,
                        'minPrice': minPrice,
                        'maxPrice': maxPrice,
                        'customsWithoutOffers': customsWithoutOffers,
                        'sortId': sortingId
                    },
                    success: function (data) {
                        $('#results').empty();
                        $('#results').html(data);
                        $.ajax({
                            type: 'GET',
                            url: "/Custom/GetCustomsCount",
                            success: function (data) {
                                if (data > pageSize) {
                                    $("#more-customs-button").show();
                                }
                                else {
                                    $("#more-customs-button").hide();
                                }
                                $("#found-customs-count").html("Найдено заказов: " + data);
                            }
                        });
                        $("#lds-ring-count").children().hide();
                    },
                    error: function (data) { alert(data.responseText); }
                });
            }


            function GetSkills() {
                var id = $('#TaskList').val();
                if (!id) {
                    id = 0;
                }
                $.ajax({
                    type: 'GET',
                    url: '@Url.Action("GetSkills", "User")/' + id,
                    dataType: 'JSON',
                    success: function (data) {
                        $('#SkillList').empty();
                        if (id != 0) {
                            $('#SkillList').attr('disabled',false);
                            $('#SkillList').append("<option value=''>Все предметы</option>");
                            $.each(data, function (i, item) {
                                $('#SkillList').append("<option value='" + item.Id + "'>" + item.Name + "</option>");
                            });
                        }
                        else {
                            $('#SkillList').append("<option value=''>Все предметы</option>");
                            $('#SkillList').attr("disabled", true);
                        }
                        $('#SkillList').selectpicker("refresh");
                    },
                    error: function (data) { alert(data.responseText); }
                });
            }

            function ResetCustoms() {
                page = 0;
                $("#lds-ring-count").children().show();
                var orderName = $("#name").val();
                var taskListId = $("#TaskList").val();
                var skillListId = $("#SkillList").val();
                var minPrice = sliderMinValue;
                var maxPrice = sliderMaxValue;
                var customsWithoutOffers = $("#customs-without-offers").is(':checked');
                var sortingId = $("#sort-customs-field").val();
                if (
                    orderName
                    || taskListId
                    || skillListId
                    || minPrice != $('#budget-range-slider').attr('data-slider-min')
                    || maxPrice != $('#budget-range-slider').attr('data-slider-max')
                    || customsWithoutOffers
                ) {
                    $("#name").val("");
                    $("#TaskList").val('').selectpicker("render");
                    $("#SkillList").val('').selectpicker("render");
                    $("#budget-range-slider").slider('refresh');
                    sliderMinValue = $('#budget-range-slider').attr('data-slider-min');
                    sliderMaxValue = $('#budget-range-slider').attr('data-slider-max');
                    $("#customs-without-offers").prop('checked', false);
                    $.ajax({
                        type: 'GET',
                        url: '/Custom/Index',
                        data: {
                            'id': page,
                            'name': "",
                            'taskCategoryId': 0,
                            'skillId': 0,
                            'minPrice': null,
                            'maxPrice': null,
                            'customsWithoutOffers': false,
                            'sortId': sortingId
                        },
                        success: function (data) {
                            $("#SkillList").attr("disabled", true);
                            $('#results').empty();
                            $('#results').html(data);
                            $.ajax({
                                type: 'GET',
                                url: "/Custom/GetCustomsCount",
                                success: function (data) {
                                    if (data > pageSize) {
                                        $("#more-customs-button").show();
                                    }
                                    else {
                                        $("#more-customs-button").hide();
                                    }
                                    $("#found-customs-count").html("Найдено заказов: " + data);
                                }
                            });
                            $("#lds-ring-count").children().hide();
                        },
                        error: function (data) { alert(data.responseText); }
                    });
                }
            }

        });
    </script>
}